<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strum City Outdoors</title>
    <style>
        body {
            background: url('https://images.unsplash.com/photo-1449452198679-0143af30f4e4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            color: limegreen;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            position: relative;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        header { text-align: center; padding: 20px; background: rgba(0,0,0,0.7); border-bottom: 2px solid limegreen; }
        header h1 { margin: 0; }
        header p { font-style: italic; }
        nav { display: flex; justify-content: center; margin: 10px 0; position: sticky; top: 0; background: black; padding: 10px; z-index: 1; }
        nav a {
            color: limegreen; text-decoration: none; padding: 10px 20px; margin: 0 5px;
            border: 1px solid limegreen; border-radius: 5px;
            transition: background 0.3s;
        }
        nav a:hover, nav a.active { background: limegreen; color: black; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.5; } }
        main { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        section { width: 80%; max-width: 800px; border: 1px solid limegreen; padding: 15px; border-radius: 5px; background: rgba(0,0,0,0.5); box-shadow: 0 0 10px limegreen; }
        .loading { color: gray; }
        footer { text-align: center; margin-top: 20px; }
        footer a { color: limegreen; }
    </style>
</head>
<body>
    <header>
        <h1>Strum City Outdoors</h1>
        <p>Message from Captain Johnny: "Ahoy, adventurers! The water's callin', but remember: Fish don't bite if you're late – gear up and let's make waves!"</p>
    </header>

    <nav>
        <a href="#dam" class="active">Dam Info</a>
        <a href="#coldspring">Coldspring Weather</a>
        <a href="#conroe">Lake Conroe Weather</a>
        <a href="#freeport">Freeport Offshore</a>
    </nav>

    <main>
        <section id="dam">
            <h2>Trinity River Lake Livingston Dam</h2>
            <p class="loading">Loading dam data...</p>
        </section>

        <section id="coldspring">
            <h2>Weather for Coldspring, TX</h2>
            <p class="loading">Loading weather...</p>
        </section>

        <section id="conroe">
            <h2>Weather for Lake Conroe, TX</h2>
            <p class="loading">Loading weather...</p>
        </section>

        <section id="freeport">
            <h2>Offshore Conditions - Freeport, TX (Buoy 42019)</h2>
            <p class="loading">Loading offshore data...</p>
        </section>
    </main>

    <footer>
        <p>Powered by nature & code. Ready for bowfishing thrills? Book a charter at <a href="https://strumcitybowfishing.com" target="_blank">Strum City Bowfishing</a> – arrows fly, fish fry, legends are made!</p>
    </footer>

    <script>
        const proxy = 'https://cors-anywhere.herokuapp.com/';

        // Dam data - tweaked parsing for robustness
        fetch(proxy + 'https://lakedata.traweb.net/Livingston.html')
            .then(res => res.text())
            .then(text => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const tables = doc.querySelectorAll('table');
                let elevation = 'N/A', discharge = 'N/A', time = 'N/A';
                if (tables.length > 0) {
                    const rows = tables[0].querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 2) {
                            let label = cells[0].textContent.trim().toLowerCase();
                            const value = cells[1].textContent.trim();
                            if (label.includes('elevation')) elevation = value;
                            if (label.includes('discharge')) discharge = value;
                        }
                    });
                    const pText = doc.querySelector('p')?.textContent || '';
                    time = pText.match(/As of (.+)/)?.[1] || 'N/A';
                }
                document.querySelector('#dam p').innerHTML = `Reservoir Elevation: ${elevation} | Discharge Rate: ${discharge} (as of ${time}).<br>Tip: High discharge = adventure time!`;
            })
            .catch(() => document.querySelector('#dam p').innerHTML = 'Dam data hiding – refresh or blame the net!');

        // Weather with wind min/max per day
        function getWeather(lat, lon, sectionId) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,precipitation&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&hourly=temperature_2m,wind_speed_10m,precipitation&forecast_days=7&timezone=America%2FChicago`;
            fetch(url)  // Open-Meteo allows direct fetch, no proxy needed
                .then(res => res.json())
                .then(data => {
                    const curr = data.current;
                    const daily = data.daily;
                    const hourly = data.hourly;
                    let html = `Current: Temp ${curr.temperature_2m}°C | Hum ${curr.relative_humidity_2m}% | Wind ${curr.wind_speed_10m} km/h from ${curr.wind_direction_10m}° | Precip ${curr.precipitation} mm<br><br>`;

                    html += `<strong>7-Day Outlook:</strong><br>`;
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(daily.time[i]).toLocaleDateString();
                        const dayStart = i * 24;
                        const dayWinds = hourly.wind_speed_10m.slice(dayStart, dayStart + 24);
                        const windMin = Math.min(...dayWinds).toFixed(1);
                        const windMax = Math.max(...dayWinds).toFixed(1);
                        html += `${date}: High ${daily.temperature_2m_max[i]}°C / Low ${daily.temperature_2m_min[i]}°C / Precip ${daily.precipitation_sum[i]} mm / Wind Min-Max ${windMin}-${windMax} km/h<br>`;
                    }
                    html += `<br><strong>Nightly Summaries (7-11pm):</strong><br>`;

                    for (let day = 0; day < 7; day++) {
                        let temps = [], winds = [], precips = 0;
                        const dayStart = day * 24;
                        for (let h = 19; h <= 23; h++) {
                            const idx = dayStart + h;
                            if (idx < hourly.time.length) {
                                temps.push(hourly.temperature_2m[idx]);
                                winds.push(hourly.wind_speed_10m[idx]);
                                precips += hourly.precipitation[idx];
                            }
                        }
                        if (temps.length > 0) {
                            const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1);
                            const maxWind = Math.max(...winds).toFixed(1);
                            const totalPrecip = precips.toFixed(1);
                            const nightDate = new Date(daily.time[day]).toLocaleDateString();
                            html += `Night of ${nightDate}: Avg Temp ${avgTemp}°C | Max Wind ${maxWind} km/h | Precip ${totalPrecip} mm<br>`;
                        }
                    }
                    document.querySelector(`#${sectionId} p`).innerHTML = html;
                }).catch(() => document.querySelector(`#${sectionId} p`).innerHTML = 'Weather ghosted – try again!');
        }
        getWeather(30.59, -95.13, 'coldspring');
        getWeather(30.35, -95.56, 'conroe');

        // Offshore: Real-time + 3-night forecast summaries (wind from forecast, waves from marine)
        Promise.all([
            fetch(proxy + 'https://www.ndbc.noaa.gov/data/realtime2/42019.txt').then(res => res.text()),
            fetch('https://api.open-meteo.com/v1/forecast?latitude=27.91&longitude=-95.35&hourly=wind_speed_10m,wind_direction_10m&daily=wind_speed_10m_max&forecast_days=3&timezone=America%2FChicago').then(res => res.json()),
            fetch('https://api.open-meteo.com/v1/marine?latitude=27.91&longitude=-95.35&hourly=wave_height,wind_wave_direction&forecast_days=3&timezone=America%2FChicago').then(res => res.json())
        ]).then(([buoyText, windData, waveData]) => {
            // Real-time from buoy
            const lines = buoyText.split('\n');
            const data = lines[2].trim().split(/\s+/);
            const waveHt = data[8];
            const domPd = data[9];
            const windSpd = data[6];
            const windDir = data[5];
            const gust = data[7];
            const waterTemp = data[12];
            const time = `${data[0]}-${data[1]}-${data[2]} ${data[3]}:${data[4]} UTC`;
            let html = `Current (Real-Time): Wave Height ${waveHt} m | Period ${domPd} s | Wind ${windSpd} m/s from ${windDir}° (Gust ${gust} m/s) | Water Temp ${waterTemp}°C (as of ${time}).<br><br>`;

            // 3-night summaries
            html += `<strong>Next 3 Nights Summaries (7-11pm):</strong><br>`;
            const hourlyWind = windData.hourly;
            const hourlyWave = waveData.hourly;
            for (let day = 0; day < 3; day++) {
                let winds = [], waveHts = [];
                const dayStart = day * 24;
                for (let h = 19; h <= 23; h++) {
                    const idx = dayStart + h;
                    if (idx < hourlyWind.time.length) {
                        winds.push(hourlyWind.wind_speed_10m[idx]);
                        waveHts.push(hourlyWave.wave_height[idx]);
                    }
                }
                if (winds.length > 0) {
                    const avgWind = (winds.reduce((a, b) => a + b, 0) / winds.length).toFixed(1);
                    const avgWave = (waveHts.reduce((a, b) => a + b, 0) / waveHts.length).toFixed(1);
                    const nightDate = new Date(windData.daily.time[day]).toLocaleDateString();
                    html += `Night of ${nightDate}: Avg Wind ${avgWind} km/h | Avg Wave Height ${avgWave} m<br>`;
                }
            }
            document.querySelector('#freeport p').innerHTML = html;
        }).catch(() => document.querySelector('#freeport p').innerHTML = 'Offshore data dipped out – refresh!');
    </script>
</body>
</html>
